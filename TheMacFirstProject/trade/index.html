<!DOCTYPE html>
<html>
<head>
 <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, minimal-ui">
    <meta name="screen-orientation" content="portrait">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="full-screen" content="yes">
    <meta name="x5-fullscreen" content="true">
    <script src="assets/js/require.js" charset="utf-8" ></script>
    <!-- <script type="text/javascript" src="assets/js/vue.js"></script> -->
    <script src="assets/js/jquery.min.js" charset="utf-8" ></script>
    
    <script src="assets/js/jquery.range.js" charset="utf-8" ></script>
    <script src="assets/js/jquery.toast.min.js" charset="utf-8" ></script>
    <script src="assets/js/myapp.js" charset="utf-8" ></script>
    <!-- <script src="assets/js/methods.js" charset="utf-8" ></script> -->
    <link rel="stylesheet" type="text/css" href="assets/css/jquery.toast.min.css">
    <!-- <link rel="stylesheet" type="text/css" href="assets/css/bootstrap.min.css"> -->
    <link rel="stylesheet" type="text/css" href="assets/css/myapp.css">

    <script>
      var vue = "assets/js/vue.js";
      var methods = "assets/js/methods.js";
      var  juabox = "assets/js/juabox.js";
      var clipboard = "assets/js/clipboard.min.js";
      var md5 = "assets/js/md5.min.js";
      var jsencrypt = "assets/js/jsencrypt.min.js";
      var country = "assets/js/country.js";
      var text = "assets/js/text.js";
      var css = "assets/js/css.js";
      var country_code = "assets/js/components/country_code/index.js"
      var highcharts = "assets/js/highcharts.js";
      var ENV = 'z';
      var ISLOGIN = false;
      // var ips = '192.168.10.127';
      var ips = getQueryString("ips");
      // var SockerUrl = "ws://"+window.location.host+":8082";
      var SockerUrl = "ws://"+ips+":8085";

      var httpUrl = "http://"+ips+"/";

     function getQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        var reg_rewrite = new RegExp("(^|/)" + name + "/([^/]*)(/|$)", "i");
        var r = window.location.search.substr(1).match(reg);
        var q = window.location.pathname.substr(1).match(reg_rewrite);
        if(r != null){
            return unescape(r[2]);
        }else if(q != null){
            return unescape(q[2]);
        }else{
            return null;
        }
    }
    // var mystr=location.href; //取得整个地址栏
    // var num=mystr.indexOf("?")
    // mystr=mystr.substr(num+1)
    var uid = getQueryString("uid");
    var touken = getQueryString("touken");
    var market = getQueryString("market");
    if(uid>0){
      ISLOGIN = true;
    }
    var user = {"uid":uid,"touken":touken};
    // console.log(market,ISLOGIN,user)
    // var user = {"uid":"180","touken":"askdhkasdhk.dak,jhkjaslkas"};
    </script>

    <script src="assets/js/main.js" charset="utf-8" ></script>


    <style type="text/css">
    .myImgsShow{
      max-width: 60%;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      margin: auto;
    }
    [v-cloak] {
      display: none !important;
    }
      .common-select a.on {
    background: #ff9d11
}
.common-select a {
    -webkit-box-flex: 0;
    -ms-flex: none;
    flex: none;
    width: 37px;
    height: 18px;
    border-radius: 30px;
    position: relative;
    -webkit-transition: all .1s ease;
    transition: all .1s ease;
    overflow: hidden;
    background: var(--selectBg);
}
.common-select a:after {
    content: "";
    display: block;
    background: #fff;
    margin: 3px 0 0 3px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    -webkit-transition: all .1s ease;
    transition: all .1s ease;
}
.common-select a.on:after {
    margin-left: 22px;
}
.common-select {
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    -webkit-box-align: center;
    -ms-flex-align: center;
    align-items: center;
}
.common-select p {
    -webkit-box-flex: 0;
    -ms-flex: none;
    flex: none;
    margin-right: 5px;
    color: var(--colorGrade2);
}
    </style>
</head>

<body>
<div id="app">
  <div class="header">
    <ul>
      <li :class="{'active' : myTradeType == '1'}">
        <a @click="myTradeTypes('1')">买入</a>
      </li>
      <li :class="{'active' : myTradeType == '0'}">
        <a @click="myTradeTypes('0')">卖出</a>
      </li>
      <li :class="{'active' : myTradeType == '2'}">
        <a @click="myTradeTypes('2')">委托</a>
      </li>
      <li :class="{'active' : myTradeType == '3'}">
        <a @click="myTradeTypes('3')">历史</a>
      </li>
    </ul>
  </div>

  <section class="mycontent" v-show="myTradeType==1 || myTradeType==0" v-cloak>
    <div class="nearside">
      <div class="entrustFir">
        <ul>
          <li class="entrust" :class="{'active' : showType == 'entrust'}" @click="setShowType('entrust')">
            市场委托
          </li>
          <li class="latest"  :class="{'active' : showType == 'latest'}"  @click="setShowType('latest')">
            最新成交
          </li>
        </ul>
      </div>
      <div class="entHtml" v-show="showType=='entrust'">
        <dish-part :dish-data="lastDepth" :market-config="currentMarketConfig" :current-market="currentMarket" :assist-price="assistPrice" ref="dishPart"></dish-part>
      </div>
      <div class="lateHtml" v-show="showType=='latest'">
        <deal-record :deal-record="dealRecord" :market-config="currentMarketConfig" :current-market="currentMarket" ref="dealRecord"></deal-record>
      </div>
      <div v-show="showType=='entrust'">
        <ul class="disType">
          <li class="trading-menu">
            <span @click="transactionTypesShows()" >{{transactionName}}</span>
            <ul class="trading-menu-dropdown" v-show="transactionTypesShow" >
              <li @click="transactionTypes('0','默认')" :class="{'active' : transactionType == '0'}">
                默认
              </li>
              <li @click="transactionTypes('1','买单')" :class="{'active' : transactionType == '1'}">
                买单
              </li>
              <li @click="transactionTypes('2','卖单')" :class="{'active' : transactionType == '2'}">
                卖单
              </li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
    <div class="offside">
      <div class="showPriceType">
        <ul>
          <li>
            价格输入转换
          </li>
          <li>
            <span v-html="showAssistName()" @click="PriceShows()"></span>
            <ul class="trading-menu-dropdown" v-show="showPriceType">
              <li role="button" @click="setAssistCoin(item.key)" :class="item.key == assistCoin ? 'active' : ''" v-for="item in assistList" >{{item.name}}</li>
            </ul>
          </li>
        </ul>
      </div>
      <div class="fill-box-body">
      <trade-form :trade-type="myTradeType" :current-user-asset="currentUserAsset" :market-config="currentMarketConfig" :current-market="currentMarket" :assist-price="assistPrice" ref="tradeFormBuy" v-show="myTradeType == 1"></trade-form>
      <trade-form :trade-type="myTradeType" :current-user-asset="currentUserAsset" :market-config="currentMarketConfig" :current-market="currentMarket" :assist-price="assistPrice" ref="tradeFormSell" v-show="myTradeType == 0"></trade-form>
      </div>
    </div>
  </section>


  <!-- 委托 -->
  <section class="mycontent" v-if="myTradeType==2" v-cloak style="display: block;padding-bottom: 0">
    <div class="entrustType">
      <ul>
        <li>
          <input type="radio" name="entrust" id="entrustAll" value="all" v-model="entrustType" >
          <label for="entrustAll">全部</label>
        </li>
        <li>
          <input type="radio" name="entrust" id="entrustBuy" value="buy" v-model="entrustType">
          <label for="entrustBuy">买单</label>
        </li>
        <li>
          <input type="radio" name="entrust" id="entrustSell" value="sell" v-model="entrustType">
          <label for="entrustSell">卖单</label>
        </li>
      </ul>
      <a >全部撤销</a>
    </div>
    <div class="entrustContent">

      <ul>
        <li>
          <div>
            时间
          </div>
          <div>
            委托价{{moneyName}}
          </div>
          <div>
            委托量/成交量{{coinName}}
          </div>
          <div>
            操作
          </div>
        </li>

        <li v-for="item in entrustArr" v-if="entrustType=='buy'?item.type==1:(entrustType=='sell'?item.type==2:( item.type==2 || item.type==1))">
          <div>
            <div>
              {{formatDateTime(item.addtime,1)}}
            </div>
            <div>
              {{formatDateTime(item.addtime,2)}}
            </div>
          </div>
          <div :class="item.type==1?'buyCol':'sellCol'">
            {{showMoney(item['price'])}}
          </div>
          <div>
           {{showCoin(item['num'])}} / {{showCoin(item['deal'])}}
          </div>
          <div>
            <a @click="doCancelEntrust(item['id'])">撤单</a>
          </div>
        </li>

      </ul>
    </div>
    <img src="assets/img/notData.png" class="myImgsShow" v-show='entrustArrLength'>

  </section>
  <!-- 历史委托 -->
  <section class="mycontent" v-if="myTradeType==3" v-cloak style="display: block;padding-bottom: 0">
    <div class="entrustType">
      <ul class="history">
        <li class="trading-menu">
          <span @click="historyTypeShow()" >类型: {{historyTypeName}}</span>
          <ul class="trading-menu-dropdown" v-show="historyType" >
            <li @click="historyTypeShows('0','全部')" :class="{'active' : historyTypes == '0'}">
              全部
            </li>
            <li @click="historyTypeShows('1','买单')" :class="{'active' : historyTypes == '1'}">
              买单
            </li>
            <li @click="historyTypeShows('2','卖单')" :class="{'active' : historyTypes == '2'}">
              卖单
            </li>
          </ul>
        </li>
        <li class="trading-menu">
          <span @click="historyStatusShow()" >状态: {{historyStatusName}}</span>
          <ul class="trading-menu-dropdown" v-show="historyStatus" >
            <li @click="historyStatusShows('0','全部')" :class="{'active' : historyStatuss == '0'}">
              全部
            </li>
            <li @click="historyStatusShows('2','已完成')" :class="{'active' : historyStatuss == '2'}">
              已完成
            </li>
            <li @click="historyStatusShows('1','委托中')" :class="{'active' : historyStatuss == '1'}">
              委托中
            </li>
            <li @click="historyStatusShows('3','已撤销')" :class="{'active' : historyStatuss == '3'}">
              已撤销
            </li>
          </ul>
        </li>
        <li class="trading-menu">
          <span @click="historyTimeShow()" >{{historyTimeName}}</span>
          <ul class="trading-menu-dropdown" v-show="historyTime" >
            <li @click="historyTimeShows('All','全部')" :class="{'active' : historyTimes == 'All'}">
              全部
            </li>
            <li @click="historyTimeShows('Recent','最近委托')" :class="{'active' : historyTimes == 'Recent'}">
              最近委托
            </li>
            <li @click="historyTimeShows('Ago','历史委托')" :class="{'active' : historyTimes == 'Ago'}">
              历史委托
            </li>
          </ul>
        </li>
      </ul>
      <!-- <img src="/uploads/20180110/8fa8bad74931e6507209e9a9c2cab80b.png" @click="$refs.inputFile.click()">
      <input type="file" ref="inputFile" style="display:none"  multiple @change="fileChange($event)"/> -->
    </div>
    <div class="entrustContent">

      <ul>
        <li>
          <div>
            时间
          </div>
          <div>
            委托价{{moneyName}}
          </div>
          <div>
            委托量/成交量{{coinName}}
          </div>
          <div>
            操作
          </div>
        </li>

        <li v-for="item in historyArr" >
          <div>
            <div>
              {{formatDateTime(item.addtime,1)}}
            </div>
            <div>
              {{formatDateTime(item.addtime,2)}}
            </div>
          </div>
          <div :class="item.type==1?'buyCol':'sellCol'">
            {{showMoney(item['price'])}}
          </div>
          <div>
           {{showCoin(item['num'])}} / {{showCoin(item['deal'])}}
          </div>
          <div v-if="item['status'] == 1">
            <a>委托中</a>
          </div>
          <div v-if="item['status'] == 2">
            <a >已完成</a>
          </div>
          <div v-if="item['status'] == 3">
            <a >已撤销</a>
          </div>
        </li>

      </ul>
    </div>
    <img src="assets/img/notData.png" class="myImgsShow" v-show='historyArrLength'>
  </section>
</div>



<!-- 这里是template -->

<script type="text/x-template" id="dish-part">
  <div id="dishWrap">

    <div class="information">
     
      <div class="price">
        价格({{ $parent.showAssistCoin()}})
      </div>
      <div>
        数量
      </div>
    </div>

    <div v-show="transactionType == 0">
      <div class="tradeData asksWrap" id="asksWrap" style="overflow:auto;">
        <ul class="tradeNew-table" >
          
        </ul>
      </div>
      <div class="newPrice">
        <div>
          最新价
        </div>
        <div class="buyCol">
          {{currentPrice}} ↑
        </div>
      </div>
      <div class="tradeData bidsWrap" id="bidsWrap" style="overflow:auto;">
        <ul class="tradeNew-table">
         
        </ul>
      </div>
    </div>
    <div v-show="transactionType ==1" >
      <div class="tradeData bidsWrap" style="height: 20.4rem;overflow:auto;" id="asksWraps" >
        <ul class="tradeNew-table">
         
        </ul>
      </div>
    </div>
    <div v-show="transactionType ==2">
      <div class="tradeData asksWrap"  style="height: 20.4rem;align-items: normal;overflow:auto;" id="asksWrapss">
        <ul class="tradeNew-table" >
          
        </ul>
      </div>
    </div>

  </div>

</script>
<script>
  require([vue, methods], function (Vue, Methods){
    Vue.component('dish-part', {
      template: "#dish-part",
      props: {
          marketConfig: {
              type: Object,
              default: function () {
                  return {message: 'hello'}
              }
          },
          dishData: {
              type: Object,
              default: function () {
                  return {}
              }
          },
          currentMarket : {
              type: String,
              default: ''
          }
      },
      data: function () {
          return {
              dishLength : 50,
              assistList : this.$parent.assistList,
              lastDepth : '',
              myTypesss:0
          }
      },
      computed: {
          transactionType : function () {
              return this.$parent.transactionType
          },
          currentPrice : function () {
              return this.$parent.showMoney(this.$parent.currentPrice);
          },
          assistPrice : function () {
              return this.$parent.getPriceByAssist(this.currentPrice);
          },
          bids : function () {
              var oArray = this.dishData.bids;
              var nArray = [];
              //获取恰当的买单档位
              if(oArray && oArray.length > 0){
                  var ilength = oArray.length;
                  //重新循环赋值才能深复制过来
                  oArray.forEach(function (item,index) {
                      if(ilength > this.dishLength){
                          if(index < this.dishLength){
                              nArray[index] = item;
                          }
                      }else{
                          nArray[index] = item;
                      }
                  }.bind(this));
              }
              return nArray;
          },
          asks : function () {
              var oArray = this.dishData.asks;
              var nArray = [];
              //获取恰当的卖单档位(取最后的this.length档)
              if(oArray && oArray.length > 0){
                  if(oArray.length > this.dishLength){
                      for(var i = 0; i < this.dishLength; i++){
                          nArray[i] = oArray[oArray.length - this.dishLength + i]
                      }
                  }else{
                      for(var i = 0; i < oArray.length; i++){
                          nArray[i] = oArray[i]
                      }
                  }
              }
              return nArray;
          }
      },
      methods: {
          getMaxDepth : function (depth) {
              var maxNum = 0 ;
              //求卖单最大深度值
              for(var i = 0;i < depth.length; i++){
                  if(parseFloat(depth[i][1]) > maxNum){
                      maxNum = parseFloat(depth[i][1]);
                  }
              }
              return maxNum;
          },
          getDepthPencent : function (number, maxNumber) {
              return Methods.fixNumber(number / maxNumber * 100, 2);
          },
          showPrice : function (price,type) {
              //格式化盘口价格
              return Methods.fixNumber(price, this.marketConfig.moneyDecimal);
          },
          showDepth : function (depth,type) {

              //格式化盘口深度
              return Methods.fixNumber(depth, this.marketConfig.coinDecimal);
          },
          changeLength : function (len) {
              this.dishLength = len;
              this.$parent.dishLength = len;
          },
          clickAsksRow : function (price,index) {
              var depth = 0,
                  _this = this,
                  len = Math.min(_this.dishLength, _this.asks.length);
              for(var i = index; i < len; i++ ){
                  depth += parseFloat(_this.asks[i][1]);
              }

              this.$parent.$refs.tradeFormBuy.flashInput();

              this.$parent.$refs.tradeFormBuy.inputPrice = price;
              this.$parent.$refs.tradeFormBuy.inputPriceConvert = this.$parent.getPriceByAssist(price);
              this.$parent.$refs.tradeFormBuy.inputNumber = depth;

              this.$parent.$refs.tradeFormSell.inputPrice = price;
              this.$parent.$refs.tradeFormSell.inputPriceConvert = this.$parent.getPriceByAssist(price);
              this.$parent.$refs.tradeFormSell.inputNumber = depth;
          },
          clickBidsRow : function (price,index) {
              var depth = 0,
                  _this = this;
              for(var i = 0; i <= index; i++ ){
                  depth += parseFloat(_this.bids[i][1]);
              }
              this.$parent.$refs.tradeFormSell.flashInput();

              this.$parent.$refs.tradeFormBuy.inputPrice = price;
              this.$parent.$refs.tradeFormBuy.inputPriceConvert = this.$parent.getPriceByAssist(price);
              this.$parent.$refs.tradeFormBuy.inputNumber = depth;

              this.$parent.$refs.tradeFormSell.inputPrice = price;
              this.$parent.$refs.tradeFormSell.inputPriceConvert = this.$parent.getPriceByAssist(price);
              this.$parent.$refs.tradeFormSell.inputNumber = depth;
          },
          bindSetPrice: function () {
              var _this = this;

              $(".asksWrap").on('touchstart', '.body', function () {
                  var price = $(this).find(".price").text();
                  var index = $(this).index();
                  _this.clickAsksRow(price, index);
              });

              $(".bidsWrap").on('touchstart', '.body', function () {
                  var price = $(this).find(".price").text();
                  var index = $(this).index();
                  _this.clickBidsRow(price, index);
              });
          },
          //盘口处理方法
          updateDepth: function (data, callback) {
              if (!data){
                  return false;
              }
              var parentAsks = $(".asksWrap .tradeNew-table");
              var parentBids = $(".bidsWrap .tradeNew-table");
              var asks = data.asks.slice(0);
              var bids = data.bids.slice(0);

              if (this.lastDepth == '') {
                  // console.log("one")
                  this.lastDepth = {};
                  this.depthInit(asks, parentAsks);
                  this.depthInit(bids, parentBids);
              } else {
                  // console.log("two")
                  var oldasks = this.lastDepth.asks.slice(0);
                  var oldbids = this.lastDepth.bids.slice(0);

                  parentAsks.find(".body.remove").remove();
                  parentAsks.find(".body.add").removeClass("add");
                  this.asksAndBids(asks, oldasks, parentAsks, this.getMaxDepth(asks));

                  parentBids.find(".body.remove").remove();
                  parentBids.find(".body.add").removeClass("add");
                  this.asksAndBids(bids, oldbids, parentBids, this.getMaxDepth(bids));
              }
              Vue.set(this.lastDepth, 'asks', data.asks.slice(0));
              Vue.set(this.lastDepth, 'bids', data.bids.slice(0));

              //刷新辅助货币的价格
              this.flushAssistPrice();
              callback && callback();
          },
          //初始化盘口
          depthInit: function (data, $obj) {
              $obj.empty();
              //console.log(data);
              if (data && data.length > 0) {
                  var view = "";

                  for (var i = 0; i < data.length; i++) {
                      
                      view += this.getRowHtml(data[i], data);
                  }
                  $obj.append(view);
                  view = null;
                  //绑定盘口点击事件
                  this.bindSetPrice();
              }
          },
          //盘口动画效果
          asksAndBids: function (addasks, oldasks, tbDiv, maxDepth) {
              //第一步比对价格相等的行，对比数量
              for (var i = 0; i < oldasks.length; i++) {
                  var isExist = false;
                  for (var j = 0; j < addasks.length; j++) {
                      if (parseFloat(oldasks[i][0]) == parseFloat(addasks[j][0])) {
                          isExist = true;
                          if (parseFloat(oldasks[i][1]) != parseFloat(addasks[j][1])) {
                              //逐行比对
                              var $amount = tbDiv.find("li:eq(" + i + ") .num");
                              var $assist = tbDiv.find("li:eq(" + i + ") .foldPrice");
                              //var $depth = tbDiv.find("div:eq(" + i + ") .depth i");
                              var amount = this.getAmount(addasks[j][1]);
                              var assist = this.getAssistPrice(addasks[j][0]);
                              //var depth = this.getDepth(addasks[j], addasks) + '%';
                              $amount.html("<span class=\"amountColor\">"+ amount +"</span>");
                              $assist.html(assist);
                          }
                          addasks.splice(j, 1);
                          break;
                      }
                  }
                  //若价格不存在则标识要移除
                  if (!isExist) {
                      tbDiv.find("li:eq(" + i + ")").addClass("remove");
                      if(tbDiv[0]==$("#asksWrap tradeNew-table")[0]){
                        console.log(11111,22)
                      }
                      var height = $("#asksWrap li").height();
                      var top = $("#asksWrap .tradeNew-table").css("top");
                      $("#asksWrap .tradeNew-table").css({"top":parseFloat(top)+height+"px"});
                      oldasks[i][2] = -1;//标识该数据对应div被移除
                  }
              }

              // console.log("a1",addasks)

              //第二步将新价格插入
              for (var j = 0; j < oldasks.length; j++) {
                  for (var i = 0; i < addasks.length; i++) {
                      if (parseFloat(addasks[i][0]) > parseFloat(oldasks[j][0])) {
                          var html = this.getRowHtml(addasks[i],addasks,"add");
                          tbDiv.find("li:eq(" + j + ")").before(html);
                          oldasks.splice(j, 0, addasks[i]);
                          addasks.splice(i, 1);
                          break;
                      }
                  }
              }

              //剩下的按新行全部插入
              var totalDiv = "";
              for (var i = 0; i < addasks.length; i++) {
                  oldasks.push(addasks[i]);
                  totalDiv += this.getRowHtml(addasks[i],addasks,'add')
              }
              if (totalDiv != '') {
                  tbDiv.append(totalDiv);
              }
             
              //执行动画效果
              tbDiv.find(".body.add").slideDown(800);
              setTimeout((function ($remove, $add) {
                  return function () {
                      $remove.slideUp(500, function () {
                          $(this).remove();
                      });
                      $add.removeClass("add");
                  };
              })(tbDiv.find(".body.remove"), tbDiv.find(".body.add")), 1000);
              
          },
          //快速刷新盘口
          quickInitTen : function () {
              var _this = this;
              //为了加快盘口显示速度连续刷10秒，后面数据更新在获取数据的接口回调中
              this.updateDepth(this.dishData, function () {

                  var timeOut = 0;
                  var dishInterval = setInterval(function () {
                      _this.updateDepth(_this.dishData);
                      timeOut += 1;
                      if(timeOut > 10){
                          window.clearInterval(dishInterval);
                      }
                  },1000)
              });
          },
          //刷新盘口和当前价格的辅助货币价格
          flushAssistPrice : function () {
              var _this = this;
              $("#dishWrap .tradeNew-table li").each(function (i) {
                  var price = $(this).find('.price').text();
                  var assistPrice = _this.$parent.getPriceByAssist(price);
                  $(this).find('.foldPrice').text(assistPrice);
              });
          },
          getPrice:function(val){
              var price = this.$parent.showMoney(val) + '';
              if(this.marketConfig.moneyDecimal == 0){
                  return [price, 0] ;
              }else{
                  return price.split('.');
              }
          },

          //得到买卖列表
          getAssistPrice:function(val){
              return this.$parent.getPriceByAssist(val);
          },
          getAmount:function(val){
              return this.$parent.showCoin(val);
          },
          getDepth:function(val,data){
              return parseFloat(val) / parseFloat(this.getMaxDepth(data)) * 100;
          },
          getRowHtml : function (arr, data, style) {
              var price = this.getPrice(arr[0]);
              var amount = this.getAmount(arr[1]);
              var assist = this.getAssistPrice(arr[0]);
              var style = style || '';
              var html = '';
              html += "<li class='body'>";
              if(this.marketConfig.moneyDecimal == 0){
                  html += "   <div class='price "+style+ "' style='display:none;'><span class=\"cor1\">"+ price[0] +"</span></div>";
              }else{
                  html += "   <div class='price "+style+ "' style='display:none;'><span class=\"cor1\">"+ price[0] +"</span><span class=\"cor2\">."+ price[1] +"</span></div>";
              }
              html += "   <div class=\"td foldPrice\">"+ assist +"</div>";
              html += "   <div class=\"td num\"><span class=\"amountColor\">"+ amount +"</span></div>";
              html += "</li>";
              this.myTypesss=1;
              return html;
          }
      },
      watch: {
        myTypesss:function(){
          // var nicesx = $("#asksWrap ul").niceScroll({
          //   touchbehavior:true,
          //   cursorcolor:"#FF00FF",
          //   cursoropacitymax:0.6,
          //   cursorwidth:24,
          //   usetransition:true,
          //   hwacceleration:true,
          //   autohidemode:"hidden",
          //   cursordragontouch:true,
          //   oneaxismousemode: false,
          //   iframeautoresize: true,
          //   // railalign: right,
          // });
          //  var nicesx = $("#bidsWrap ul").niceScroll({
          //   touchbehavior:true,
          //   cursorcolor:"#FF00FF",
          //   cursoropacitymax:0.6,
          //   cursorwidth:24,
          //   usetransition:true,
          //   hwacceleration:true,
          //   autohidemode:"hidden",
          //   cursordragontouch:true,
          //   oneaxismousemode: false,
          //   iframeautoresize: true,
          //   // railalign: right,
          // });
          //   $("#asksWrap ul").scrollTop($("#asksWrap ul")[0].scrollHeight);
            // tuodong("asksWrap",8)
            // tuodongs("asksWraps",17)
            // tuodongs("asksWrapss",17)
            // tuodongs("bidsWrap",8)
            // tuodongs("tradeRecord",17)
            $("#asksWrap").scrollTop($("#asksWrap")[0].scrollHeight);
          
        }
      },
      mounted: function() {
          this.bindSetPrice();
          this.quickInitTen();

      }

    })
  })
</script>

<script type="text/x-template" id="deal-record">
  <div>
    <div class="information">
      <div class="item time"><span>时间</span></div>
      <div class="item foldPrice2">
          <div class="common-select" id="myColors">
              <span v-if="showAssistPrice">成交折价({{ $parent.showAssistCoin()}})</span>
              
          </div>
      </div>
      <div class="item num"><span>数量</span></div>
    </div>
    <div class="plate-box-body" id="tradeRecord">
        <div class="tradeNew-table" :class="{'showAssistPrice' : showAssistPrice}">
        </div>
    </div>
  </div>
</script>

<script>

    require([vue, methods], function (Vue, Methods){
        return Vue.component('deal-record', {
            template: "#deal-record",
            props: {
                marketConfig: {
                    type: Object,
                    default: function () {
                        return {}
                    }
                },
                dealRecord: {
                    type: Array,
                    default: function () {
                        return []
                    }
                },
                currentMarket : {
                    type: String,
                    default: ''
                }
            },
            data: function () {
                return {
                    tradeDate:new Date(),
                    showAssistPrice : true
                }
            },
            computed: {
            },
            methods: {
                dateFormatTf: function (i) {
                    return (i < 10 ? '0' : '') + i;
                },
                dateFormat: function (currentDate) {
                    return currentDate.getFullYear()
                        + "-" + this.dateFormatTf(currentDate.getMonth() + 1)
                        + "-" + this.dateFormatTf(currentDate.getDate())
                        + " " + this.dateFormatTf(currentDate.getHours())
                        + ":" + this.dateFormatTf(currentDate.getMinutes())
                        + ":" + this.dateFormatTf(currentDate.getSeconds());
                },
                //处理成交记录
                setFirstRecord: function (item) {
                  // console.log(item,2)
                    if (item != null && item.length > 0) {
                        //初始化50条交易记录
                        var totalUls = "";
                        for (var i = item.length - 1; i >= 0; i--) {
                            totalUls += this.getRowHtml(item[i]);
                        }
                        $("#tradeRecord .tradeNew-table").html(totalUls);
                    }
                },
                toggleInputShow: function(){
                    this.showAssistPrice = !this.showAssistPrice
                },
                pushTrades: function (array) {
                    var $this = this;
                    var $trades = $("#tradeRecord .tradeNew-table");
                    var totalUls = "";
                    if (array == '' && array.length == 0) {
                        return false;
                    }
                    for (var i = array.length - 1; i >= 0; i--) {
                        var item = array[i];
                        if (i >= array.length - $this.$parent.tradesLimit) {

                            if (item.tid <= $this.$parent.last_trade_tid) continue;

                            if (this.$parent.last_trade_tid != 0) {
                                totalUls += $this.getRowHtml(item, 'add');
                                
                            } else {
                                totalUls += $this.getRowHtml(item);
                            }
                        }
                    }
                    if ($this.$parent.last_trade_tid != 0) {
                        $trades.prepend(totalUls);
                    } else {
                        $trades.append(totalUls);
                    }
                    totalUls = null;
                    $trades.find(".add").slideDown(1000, function () {
                        $(this).removeClass("add");
                    });
                    //删除大于100条的数据
                    $trades.find(".tr:gt(" + (this.$parent.tradesLimit - 1) + ")").remove();
                },
                getRowHtml : function (item, style) {
                    this.tradeDate.setTime(item.date * 1000);
                    var dateStr = this.dateFormatTf(this.tradeDate.getHours())
                        + ":" + this.dateFormatTf(this.tradeDate.getMinutes())
                        + ":" + this.dateFormatTf(this.tradeDate.getSeconds());
                    var price = this.$parent.showMoney(item.price).split(".");
                    var assist = this.$parent.getPriceByAssist(item.price).split(".");
                    var amount = this.$parent.showCoin(item.amount);
                    var style = style || '';
                    var amountClass = item.type == 'buy' ? 'buyCol' : 'sellCol';
                    var html = "";
                    html += "<div class=\"tr body "+ style +"\">";
                    html += "   <div class=\"td time\">"+ dateStr +"</div>";
                    html += "   <div class=\"td price\" style='display:none;'><span class=\"cor1\" >"+ price[0] +"</span><span class=\"cor2\">."+ price[1] +"</span></div>";
                    html += "   <div class='td foldPrice "+amountClass+" '><span class=\"cor1\">"+ assist[0] +"</span><span class=\"cor2\">."+ assist[1] +"</span></div>";
                    html += "   <div class=\"td num\"><span>"+ amount +"</span></div>";
                    html += "</div>";
                    return html;
                },
                clickRow : function (price) {
                    this.$parent.$refs.tradeFormBuy.inputPrice = price;
                    this.$parent.$refs.tradeFormBuy.inputPriceConvert = this.$parent.getPriceByAssist(price);

                    this.$parent.$refs.tradeFormSell.inputPrice = price;
                    this.$parent.$refs.tradeFormSell.inputPriceConvert = this.$parent.getPriceByAssist(price);
                },
                bindSetPrice: function () {
                    var _this = this;
                    $("#tradeRecord").on('touchstart', '.body', function () {
                        var price = $(this).find(".price").text();
                        _this.clickRow(price);
                    });
                },
                //刷新交易记录的辅助货币价格 成交价 折合价
                flushAssistPrice : function () {
                    var _this = this;
                    $("#tradeRecord .tradeNew-table .tr").each(function (i) {
                        var price = $(this).find('.price').text();
                        var assistPrice = _this.$parent.getPriceByAssist(price);
                        $(this).find('.foldPrice').text(assistPrice);
                    });
                }
            },
            watch: {

            },
            mounted: function() {
                
                this.bindSetPrice();
            }
        });
    })

</script>


<script type="text/x-template" id="trade-form">
    <!--卖出表单开始-->
    <div class="box" :class="{'flash' : flashForm}" v-if="tradeType == 0">
        
        <div class="box-body">
            <div class="input">

                <!--原始价格输入-->
                <template v-if="inputPriceMode == 0">
                    <label class="p" ><span>{{ $parent.buyOne}}{{moneyName}}</span></label>
                    <input class="sellColor" type="text" v-model="inputPrice" @input="convertPrice($event,0)" v-on:change="convertPrice($event,0)"  placeholder="卖出价" />
                </template>
            </div>
            <div class="input" style="  ">
                <div class="coverPrice" style="text-align: right;">≈<font class="buyColor">{{inputPriceConvert}}</font> {{showAssistCoin}}</div>
            </div>

            <div class="input">
                <label class="p" id="sellVolumLable" v="323.19" ><span>{{coinName}}</span></label>
                <input class="sellColor" type="text" v-model="inputNumber" placeholder="卖出量">
            </div>
            <div class="rangeSlider">
              <div style="    margin-bottom: 0.3rem;">
                卖出比例
              </div>
              <ul>
                <li @click="wolegeca('25')">25%</li>
                <li @click="wolegeca('50')">50%</li>
                <li @click="wolegeca('75')">75%</li>
                <li @click="wolegeca('100')">100%</li>
              </ul>
            </div>
            <div :id="'rangeSlider_' + tradeType" class="range range_sell"><!-- 滑动杆 --><span class="sliderPercent"></span></div>
            <div class="settle">
              <p>订单金额</p>
              <p style="text-align: right;">
                <font class="buyColor hint--top-left" :aria-label="showAssistTotalAmount" style="float: left;">{{totalAmount}}</font>
                 {{moneyName}}
               </p>
             </div>
             <div class="input">
                <input class="sellColor"  type="password" v-model="inputPassword" placeholder="交易密码">
            </div>

            

            <div class="box-btn">
                <a @click="doCheckEntrust" class="sellBgColor" role="button" v-html="showButton" :class="{'disabled' : requestLocked || !isLogin}"></a>
            </div>
        </div>
        <div class="box-head">
            <p>可用{{moneyName}}:<font class="buyColor" :class="{'hint--top-left' : $parent.currentMarketLever}">{{canUseMoney}}</font></p>
            <p>可买{{coinName}}:<font class="buyColor" :class="{'hint--top-left' : $parent.currentMarketLever}"></font>{{canUseMoneys}}</p>
        </div>
        <div style="margin-top: .25rem;">
            <p>可用{{coinName}}:<font class="sellColor" :class="{'hint--top-left' : $parent.currentMarketLever}" >{{canUseCoin}}</font></p>
            <p>可卖{{moneyName}}:<font class="buyColor" :class="{'hint--top-left' : $parent.currentMarketLever}">{{canUseCoins}}</font></p>
        </div>
    </div>










    <div class="box" :class="{'flash' : flashForm}" v-else="">
      
        
        <div class="box-body">
            
           


            <div class="input">
                <template v-if="inputPriceMode == 0">
                    <label class="t" v-if="tradeMode == 1"><span>最高买入价</span></label>
                    <label class="p" ><span>{{ $parent.sellOne}} {{moneyName}}</span></label>
                    <input class="buyColor" type="text" v-model="inputPrice" @input="convertPrice($event,0)" v-on:change="convertPrice($event,0)" placeholder="买入价" />
                </template>

                <template v-if="inputPriceMode != 0">
                    <label class="t" v-if="tradeMode == 1"><span>:__('Maximum buy price')}{{showAssistCoin}}</span></label>
                    <label class="p" ><span>{{ $parent.getPriceByAssist($parent.sellOne)}}{{showAssistCoin}}</span></label>
                    <input class="buyColor" type="text" v-model="inputPriceConvert" @input="convertPrice($event,3)" v-on:change="convertPrice($event,3)" placeholder="买入价" />
                </template>
            </div>
            <div class="input" style="  ">
                <div class="coverPrice" style="text-align: right;">≈<font class="buyColor">{{inputPriceConvert}}</font> {{showAssistCoin}}</div>
            </div>
            <div class="input">
                <label class="p" ><span>{{coinName}}</span></label>
                <input class="buyColor" type="text" v-model="inputNumber" placeholder="买入量">
                <i class="up" @click="UpDownNumber(1,1)"></i>
                <i class="down" @click="UpDownNumber(1,0)"></i>
            </div>

            <div class="rangeSlider">
              <div style="    margin-bottom: 0.3rem;">
                买入比例
              </div>
              <ul>
                <li @click="wolegeca('25')">25%</li>
                <li @click="wolegeca('50')">50%</li>
                <li @click="wolegeca('75')">75%</li>
                <li @click="wolegeca('99.9999')">100%</li>
              </ul>
            </div>

            <div :id="'rangeSlider_' + tradeType" class="range range_buy"></div>
            <div class="settle">
              <p>订单金额</p>
              <p style="text-align: right;">
                <font class="buyColor hint--top-left" :aria-label="showAssistTotalAmount" style="float: left;">{{totalAmount}}</font>
                 {{moneyName}}
               </p>
             </div>
            <div class="input">
                <input class="buyColor" type="password" v-model="inputPassword" placeholder="交易密码" >
            </div>
            <div class="box-btn">
                <a @click="doCheckEntrust" class="buyBgColor" role="button" v-html="showButton" :class="{'disabled' : requestLocked || !isLogin}"></a>
            </div>
        </div>

        <div class="box-head">
            <p>可用{{moneyName}}:<font class="buyColor" :class="{'hint--top-left' : $parent.currentMarketLever}">{{canUseMoney}}</font></p>
            <p>可买{{coinName}}:<font class="buyColor" :class="{'hint--top-left' : $parent.currentMarketLever}"></font>{{canUseMoneys}}</p>
        </div>
        <div style="margin-top: .25rem;">
            <p>可用{{coinName}}:<font class="sellColor" :class="{'hint--top-left' : $parent.currentMarketLever}" >{{canUseCoin}}</font></p>
            <p>可卖{{moneyName}}:<font class="buyColor" :class="{'hint--top-left' : $parent.currentMarketLever}">{{canUseCoins}}</font></p>
        </div>
    </div>
</script>

<!--引入交易表单app-->
<script>
    require([vue, methods, juabox], function (Vue, Methods, JuaBox) {
        return Vue.component('trade-form', {
            template: "#trade-form",
            props: {
                marketConfig: {
                    type: Object,
                    default: function () {
                        return {};
                    }
                },
                //交易类型 0卖，1买
                tradeType: {
                    type: [String, Number],
                    default: 0
                },
                assistPrice: {
                    type: Object,
                    default: function () {
                        return null;
                    }
                },
                currentUserAsset: {
                    type: Object,
                    default: function () {
                        return null;
                    }
                },
                currentMarket: {
                    type: String,
                    default: ""
                }
            },
            data: function () {
                return {
                    isLogin: ISLOGIN,
                    inputPrice: '',
                    inputMaxPrice: '',
                    inputMinPrice: '',
                    inputPriceConvert: '',
                    inputMaxPriceConvert: '',
                    inputMinPriceConvert: '',
                    inputNumber: '',
                    rangeSlider : '',
                    rangePercent : '0.00',
                    requestLocked : false,
                    //委托类型 0限价委托，1批量委托，2计划委托
                    tradeMode : 0,
                    flashForm : false,
                    inputPassword:''
                }
            },
            computed: {
                //输入价格模式：0输入原始价格，1输入转换价格
                inputPriceMode : function () {
                    return this.$parent.inputPriceMode;
                },
                showAssistCoin : function () {
                    return this.$parent.showAssistCoin();
                },
                canUseCoin : function(){
                    return this.$parent.canUseCoin;
                },
                canUseCoins : function(){
                    return this.$parent.canUseCoins;
                },
                canUseMoney : function(){
                    return this.$parent.canUseMoney;
                },
                canUseMoneys : function(){
                    return this.$parent.canUseMoneys;
                },
                canUseCoinReal : function(){
                    return this.$parent.canUseCoinReal;
                },
                canUseMoneyReal : function(){
                    return this.$parent.canUseMoneyReal;
                },
                realCanBuyCoin : function () {
                    if(this.inputPrice != ''){
                        return Methods.fixDecimal(this.canUseMoney/this.inputPrice, this.marketConfig.coinDecimal);
                    }else{
                        return this.$parent.canBuyCoin;
                    }
                },
                realCanSellMoney : function () {
                    if(this.inputPrice != ''){
                        return Methods.fixDecimal(this.canUseCoin * this.inputPrice, this.marketConfig.moneyDecimal);
                    }else{
                        return this.$parent.canSellMoney;
                    }
                },
                coin : function(){
                    return this.marketConfig.coin;
                },
                money : function(){
                    return this.marketConfig.money;
                },
                coinName : function(){
                    return this.marketConfig.coinName;
                },
                moneyName : function(){
                    return this.marketConfig.moneyName;
                },
                currentAccountId : function(){
                    return this.$parent.currentAccountId;
                },
                assistRegEx : function(){
                    return new RegExp("^(([1-9]{1}\\d*)|([0]{1}))(\\.(\\d){0," + this.$parent.assistList[this.$parent.assistCoin].decimal + "})?$");
                },
                moneyRegEx : function(){
                    return new RegExp("^(([1-9]{1}\\d*)|([0]{1}))(\\.(\\d){0," + this.marketConfig.moneyDecimal + "})?$");
                },
                coinRegEx : function(){
                    return new RegExp("^(([1-9]{1}\\d*)|([0]{1}))(\\.(\\d){0," + this.marketConfig.coinDecimal + "})?$");
                },
                totalAmount : function () {
                    if(this.inputPrice && this.inputNumber && this.tradeMode == 0){
                        return Methods.fixDecimal(Methods.numMultiply(this.inputPrice, this.inputNumber), this.marketConfig.amountDecimal);
                    }else{
                        return '--';
                    }
                },
                showAssistTotalAmount: function () {
                    if(!isNaN(this.totalAmount)){
                        return "折合:" + this.$parent.getPriceByAssist(this.totalAmount) + " " + this.showAssistCoin;
                    }
                },
                showButton : function () {
                    if(this.isLogin){
                        if(this.requestLocked){
                            return "正在提交委托...";
                        }
                        if(this.tradeMode == 0){
                            if(this.tradeType == 0){
                                return "卖出";
                            }
                            if(this.tradeType == 1){
                                return "买入";
                            }
                        }
                        
                    }else{
                        return "立即登录";
                    }

                },
                //单独写的动态计算显示百分比数据
                showPercent : function () {
                    //此处不做超出100%验证，监视属性中计算
                    if(this.isLogin){
                        if(this.tradeType == 1 && this.inputPrice && this.inputNumber && parseFloat(this.canUseMoney) > 0){
                            return Methods.fixNumber(this.inputPrice * this.inputNumber / this.canUseMoney * 100, 2);
                        }
                        if(this.tradeType == 0  && this.inputNumber&& parseFloat(this.canUseCoin) > 0){
                            return Methods.fixNumber(this.inputNumber / this.canUseCoin * 100, 2);
                        }
                    }
                    return '0.00';
                },
                priceCover : function () {
                    return this.$parent.getPriceByAssist(this.inputPrice);
                },
                maxPriceCover : function () {
                    return this.$parent.getPriceByAssist(this.inputMaxPrice);
                },
                minPriceCover : function () {
                    return this.$parent.getPriceByAssist(this.inputMinPrice);
                }
            },
            methods: {
                doCheckEntrust: function () {
                    var showError = function (msg) {
                        $.toast({
                            heading: "订单提交错误",
                            text: msg,
                            showHideTransition: 'fade',
                            icon: 'error'
                        });
                    }
                    if (!this.isLogin) {
                             alert("请登录！");
                             return false;
                        // return showError(`请先&nbsp;<a href="{:url('index/login/index')}">登录</a>&nbsp;再进行交易。`);

                    }
                    /*if(this.currentMarket == 'bot_qtum'){
                        if(parseFloat(this.inputPrice) > 0.033333 || parseFloat(this.inputMaxPrice) > 0.033333 || parseFloat(this.inputMinPrice) > 0.033333 ){
                            return JuaBox.info("买入价格不得高于预售价格0.033333 QTUM");
                        }
                    }*/
                    //请求锁 防止重复提交
                    if (this.requestLocked) {
                        return showError("您有未完成的订单请求，请稍候再提交。");
                    }
                    var _priceProtect = parseFloat(this.$parent.currentMarketConfig.priceProtect);  //价格保护系数
                    var _sellOne = parseFloat(this.$parent.sellOne);  //卖一价
                    var _buyOne = parseFloat(this.$parent.buyOne);    //买一价
                    var _percentProtect = ((parseFloat(_priceProtect) - 1) * 100).toFixed(2);
                    //校验限价委托表单数据
                    if(this.tradeMode == 0){
                        if (!this.moneyRegEx.test(this.inputPrice) || this.inputPrice == 0 || this.inputPrice == '') {
                            return showError("请输入正确的委托金额");
                        }
                        if (!this.coinRegEx.test(this.inputNumber) || this.inputNumber == 0 || this.inputNumber == '') {
                            return showError("请输入正确的委托数量");
                        }
                    //有问题  看这里
                                if (this.inputPassword =="" || this.inputPassword ==null) {
                                    return showError("请输入交易密码");
                                }
                          
                        //提交委托
                        this.doSubmitEntrust();
                    }
                },
                doSubmitEntrust: function () {
                    var text = '';
                    if (this.tradeType == 0) {
                        text = "价格" + this.inputPrice + "" + this.moneyName + "卖" + this.coinName + this.inputNumber;
                    } else if (this.tradeType == 1) {
                        text = "价格" + this.inputPrice + "" + this.moneyName + "买" + this.coinName + this.inputNumber;
                    } else {
                        return console.log('unknown trade type')
                    }
                    var data = {
                        market: this.currentMarket,
                        unitPrice: this.inputPrice,
                        number: this.inputNumber,
                        password:this.inputPassword,
                        type:this.tradeType==0?2:this.tradeType,
                        user:user
                    };
                    //锁定请求
                    this.requestLocked = true;
                    
                    $.ajax({
                      type:"post",
                      url: httpUrl+"app/Trade/place_order",
                      // url: "{:url('Trade/place_order')}",
                      data: data,
                      dataType:"jsonp",
                      success: function (res) {
                        if(res.code==1){
                            //解除请求锁定
                            this.requestLocked = false;
                            //清除输入框内容
                            this.clearEntrustInput();
                            //马上刷新委托和资金
                            var int = 0;
                            var call = setInterval(function () {
                                int ++ ;
                                if(int <= 3){
                                    this.$parent.lastAssetTime = 0;
                                    // this.$parent.getTargetUserAsset();
                                }else {
                                    window.clearInterval(call);
                                }
                            }.bind(this),1000)

                            $.toast({
                                heading: "订单已执行",
                                text: text,
                                icon: 'success',
                                loader: true,
                                loaderBg: '#9EC600'
                            });
                        }else{
                            //解除请求锁定
                            this.requestLocked = false;
                            $.toast({
                                heading: res.msg,
                                icon: 'error',
                                loader: true,
                                loaderBg: '#9EC600'
                            });
                        }
                        }.bind(this)

                    })
                },
                
                clearEntrustInput : function () {
                    this.inputPrice = '';
                    this.inputMaxPrice = '';
                    this.inputMinPrice = '';
                    this.inputPriceConvert = '';
                    this.inputMaxPriceConvert = '';
                    this.inputMinPriceConvert = '';
                    this.inputNumber = '';
                    this.inputPassword = '';
                },
                changeTradeMode : function (type) {
                    this.tradeMode = type;
                },
                initSlider : function () {
                    var _this = this;
                    var rangeId = "#rangeSlider_" + _this.tradeType;
                    if($(rangeId).length == 0){
                        return false;
                    }
                    this.rangeSlider = new BitRange({
                        range: rangeId,
                        step: 0.01,
                        point: 5,
                        delay: 15,
                        slide: function(value, obj) {
                            if(_this.checkSlider()){
                                _this.rangeSlider.Update(value);
                                _this.rangePercent = value;
                            }else{
                                _this.rangeSlider.Update(0);
                                _this.rangePercent = 0;
                                return false;
                            }
                        }
                    });
                },
                //判断当前滑动杆是否可用
                checkSlider : function () {
                    if(!this.isLogin){
                        return false;
                    }
                    if(this.tradeType == 0 && this.canUseCoin == 0){
                        return false;
                    }
                    if(this.tradeType == 1 && (this.canUseMoney == 0 || this.inputPrice == '' || this.inputPrice == 0)){
                        return false;
                    }
                    return true;
                },
                wolegeca:function(num){
                  if(this.$parent.myTradeType=="1"){
                    if(this.inputPrice>0){
                      this.inputNumber = this.canUseMoney*num/100/ this.inputPrice;
                    }
                  }else{
                    this.inputNumber = this.canUseCoin*num/100
                  }
                  
                  
                  // Methods.fixNumber(this.inputPrice * this.inputNumber / this.canUseMoney * 100, 2);
                },
                checkNumberByPercent : function () {
                    if(this.isLogin){
                        var percent = parseFloat(this.showPercent);
                        //若超过100%则按100%计算
                        if(percent > 100){
                            percent = 100;
                            if(this.tradeType == 1 && this.inputPrice != '' && this.inputPrice != 0){
                                this.inputNumber = this.canUseMoney / this.inputPrice;
                            }
                            if(this.tradeType == 0){
                                this.inputNumber = this.canUseCoin;
                            }
                        }
                        if(this.rangeSlider){
                            this.rangeSlider.Update(percent);
                        }
                    }
                },
                //切换输入框上的label
                toggleLabel : function () {
                    if(this.$parent.theme == 'light'){
                        return false;
                    }
                    $('.box input').on('focus',function () {
                        $(this).parent().addClass('focus');
                    });
                    $('.box input').on('blur',function () {
                        $(this).parent().removeClass('focus');
                    });
                },
                //增加或减少数量、价格
                UpDownNumber : function (type, flag) {
                    //flag 0- 1+
                    //type:
                    //0:inputPrice
                    //1:inputNumber
                    //2:inputMaxPrice
                    //3:inputMinPrice
                    
                    if(!this.isLogin){
                        return false;
                    }
                    var _this = this;
                    var step = 0.01;

                    switch(type){
                        case 0:
                            if(this.inputPrice == '' || this.inputPrice == 0){
                                if(this.tradeType == 0){
                                    this.inputPrice = this.$parent.buyOne;
                                    this.inputPriceConvert = this.$parent.getPriceByAssist(this.$parent.buyOne);
                                }else{
                                    this.inputPrice = this.$parent.sellOne;
                                    this.inputPriceConvert = this.$parent.getPriceByAssist(this.$parent.sellOne);
                                }
                            }else{
                                if(flag == 0){
                                    this.inputPrice = this.inputPrice * (1 - step);
                                    this.inputPriceConvert = this.inputPriceConvert * (1 - step);
                                }else{
                                    this.inputPrice = this.inputPrice * (1 + step);
                                    this.inputPriceConvert = this.inputPriceConvert * (1 + step);
                                }
                            }
                            break;
                        case 1:

                            if(this.inputNumber == '' || this.inputNumber == 0){
                                if(this.tradeType == 0){
                                    this.inputNumber = this.canUseCoin *  step;
                                }else{
                                    this.inputNumber = this.$parent.canBuyCoin * step;
                                }
                            }else{
                                if(flag == 0){
                                    this.inputNumber = this.inputNumber * (1 - step);
                                }else{
                                    this.inputNumber = this.inputNumber * (1 + step);
                                }
                            }
                            break;
                        case 2:
                            if(this.inputMaxPrice == '' || this.inputMaxPrice == 0){
                                if(this.tradeType == 0){
                                    this.inputMaxPrice = this.$parent.buyOne;
                                    this.inputMaxPriceConvert = this.$parent.getPriceByAssist(this.$parent.buyOne);
                                }else{
                                    this.inputMaxPrice = this.$parent.sellOne;
                                    this.inputMaxPriceConvert = this.$parent.getPriceByAssist(this.$parent.sellOne);
                                }
                            }else{
                                if(flag == 0){
                                    this.inputMaxPrice = this.inputMaxPrice * (1 - step);
                                    this.inputMaxPriceConvert = this.inputMaxPriceConvert * (1 - step);
                                }else{
                                    this.inputMaxPrice = this.inputMaxPrice * (1 + step);
                                    this.inputMaxPriceConvert = this.inputMaxPriceConvert * (1 + step);
                                }
                            }
                            this.inputMaxPrice = Methods.fixFloat(this.inputMaxPrice, this.marketConfig.moneyDecimal);
                            this.inputMaxPriceConvert = Methods.fixFloat(this.inputMaxPriceConvert, this.$parent.assistList[this.$parent.assistCoin].decimal);
                            break;
                        case 3:
                            if(this.inputMinPrice == '' || this.inputMinPrice == 0){
                                if(this.tradeType == 0){
                                    this.inputMinPrice = this.$parent.buyOne;
                                    this.inputMinPriceConvert = this.$parent.getPriceByAssist(this.$parent.buyOne);
                                }else{
                                    this.inputMinPrice = this.$parent.sellOne;
                                    this.inputMinPriceConvert = this.$parent.getPriceByAssist(this.$parent.sellOne);
                                }
                            }else{
                                if(flag == 0){
                                    this.inputMinPrice = this.inputMinPrice * (1 - step);
                                    this.inputMinPriceConvert = this.inputMinPriceConvert * (1 - step);
                                }else{
                                    this.inputMinPrice = this.inputMinPrice * (1 + step);
                                    this.inputMinPriceConvert = this.inputMinPriceConvert * (1 + step);
                                }
                            }
                            this.inputMinPrice = Methods.fixFloat(this.inputMinPrice, this.marketConfig.moneyDecimal);
                            this.inputMinPriceConvert = Methods.fixFloat(this.inputMinPriceConvert, this.$parent.assistList[this.$parent.assistCoin].decimal);
                            break;
                        default:
                            return false;
                    }
                },
                //转换输入的价格（使用事件触发）
                convertPrice : function (e, type,status) {
                    //输入价格
                    if(status==1){
                      var price = e;
                    }else{
                      var price = e.target.value || e;
                    }
                    /*if(price == '' || isNaN(price)){
                        return '--';
                    }*/
                    //转换的价格
                    var aPrice = this.$parent.getPriceByAssist(price);
                    var cPrice = this.$parent.getPriceByPrice(price);
                    switch(type) {
                        case 0:
                            this.inputPriceConvert = aPrice;
                            break;
                        case 1:
                            this.inputMaxPriceConvert = aPrice;
                            break;
                        case 2:
                            this.inputMinPriceConvert = aPrice;
                            break;
                        case 3:
                            this.inputPrice = cPrice;
                            break;
                        case 4:
                            this.inputMaxPrice = cPrice;
                            break;
                        case 5:
                            this.inputMinPrice = cPrice;
                            break;
                        default :
                            return '--'
                    }
                },
                //点选价格后闪烁2秒
                flashInput : function () {
                    this.flashForm = true;
                    setTimeout(function () {
                        this.flashForm = false;
                    }.bind(this), 1000)
                },
                //点选百分百买卖
                setPercent : function (val) {
                    this.rangePercent = parseFloat(val) * 100;
                }
            },
            watch: {
                //inputPrice && inputPriceConvert，
                //inputMaxPrice && inputMaxPriceConvert，
                //inputMinPrice && inputMinPriceConvert
                //这三对属性无法在监视属性中相互触发，否则会陷入死循环，已改为事件单独触发同步，待优化解决
                inputPrice : function (newVal, oldVal) {
                    //监视数据不合格则先转换
                    if (!this.moneyRegEx.test(newVal) && newVal != '') {
                        this.inputPrice = Methods.checkDecimal(newVal, this.marketConfig.moneyDecimal);
                    }
                    this.checkNumberByPercent();
                },
                inputMaxPrice : function (newVal, oldVal) {
                    //监视数据不合格则先转换
                    if (!this.moneyRegEx.test(newVal) && newVal != '') {
                        this.inputMaxPrice = Methods.checkDecimal(newVal, this.marketConfig.moneyDecimal);
                    }
                },
                inputMinPrice : function (newVal, oldVal) {
                    //监视数据不合格则先转换
                    if (!this.moneyRegEx.test(newVal) && newVal != '') {
                        this.inputMinPrice = Methods.checkDecimal(newVal, this.marketConfig.moneyDecimal);
                    }
                },
                inputNumber : function (newVal, oldVal) {
                    //监视数据不合格则先转换
                    if(this.isLogin && this.tradeType == 1 && this.canUseMoney == 0){
                        //登陆后若没有资金则不赋值
                        this.inputNumber = 0;
                    }
                    if(this.isLogin && this.tradeType == 0 && this.canUseCoin == 0){
                        //登陆后若没有资金则不赋值
                        this.inputNumber = 0;
                    }
                    if (!this.coinRegEx.test(newVal) && newVal != '') {
                        this.inputNumber = Methods.checkDecimal(newVal, this.marketConfig.coinDecimal);
                    }
                    this.checkNumberByPercent();
                },
                inputPriceConvert : function (newVal, oldVal) {
                    //监视数据不合格则先转换
                    if (!this.assistRegEx.test(newVal) && newVal != '') {
                        this.inputPriceConvert = Methods.checkDecimal(newVal, this.$parent.assistList[this.$parent.assistCoin].decimal);
                    }
                },
                inputMaxPriceConvert : function (newVal, oldVal) {
                    //监视数据不合格则先转换
                    if (!this.assistRegEx.test(newVal) && newVal != '') {
                        this.inputMaxPriceConvert = Methods.checkDecimal(newVal, this.$parent.assistList[this.$parent.assistCoin].decimal);
                    }
                },
                inputMinPriceConvert : function (newVal, oldVal) {
                    //监视数据不合格则先转换
                    if (!this.assistRegEx.test(newVal) && newVal != '') {
                        this.inputMinPriceConvert = Methods.checkDecimal(newVal, this.$parent.assistList[this.$parent.assistCoin].decimal);
                    }
                },
                rangePercent : function (newVal, oldVal) {
                    if(newVal > 0){
                        if(this.tradeType == 0){
                            this.inputNumber = this.canUseCoin * newVal * 0.01;
                        }else{
                            this.inputNumber = this.canUseMoney / this.inputPrice  * newVal * 0.01;
                        }
                    }else{
                        this.inputNumber = '';
                    }
                },
                tradeMode : function () {
                    setTimeout(this.toggleLabel, 300);
                },
                inputPriceMode : function () {
                    setTimeout(this.toggleLabel, 300);
                }
            },
            mounted: function () {
                //this.initSlider();
                this.toggleLabel();
                //解决有时候不显示
                setTimeout(this.initSlider, 3000);
            }
        });
    })

</script>





<script>

require([vue, methods, juabox], function (Vue, Methods, JuaBox) {
  new Vue({
    el: "#app",
    data: function () {
      return {
        showType :"entrust",
        money :"usdt",
        assistCoin : "none",
        transactionType :"0",
        transactionName :"默认",
        transactionTypesShow:false,
        showPriceType:false,
        depthShowSize:50,
        casuals:0,
        currentPrice : "--",
        lastDepth : {
            asks : [],
            bids : [],
            maxbBids: "0",
            maxbAsks:"0"
        },
        currentMarket: market,
        coin: "ltc",
        money: "btc",
        coinName: "LTC",
        moneyName: "BTC",
        siteTitle : document.title,
        marketConfig: null,
        assistList : {
            'none': {key:'none', name: "默认", icon: '', symbol: '฿',decimal : 6},
            //'btc': {key: 'btc', name: 'BTC', icon: 'icon-btc', symbol: '฿',decimal : 6},
            'usd': {key: 'usd', name: 'USD', icon: 'icon-meiyuan', symbol: '$',decimal : 3},
            'cny': {key: 'cny', name: 'CNY', icon: 'icon-cny', symbol: '¥',decimal : 3}
        },
        assistPrice : null,
        dealRecord : [],

        lastAssetTime : 0,
        currentUserAsset : {
            userFund : {},
            marketLevers : {}
        },
        allMarket : null,
        isMobile: Methods.isMobile(),
        isLogin: ISLOGIN,
        dishLength : 5,
        highPrice : '--',
        lowPrice : '--',
        volume : '--',
        riseRate : '0.00',
        buyOne : '',
        sellOne : '',
        mycess:[],
        tradesLimit : 100,
        last_trade_tid : 0,
        last_trade_time : 0,
        rateClass : 'text-primary trading-redcolor',
        priceClass : 'text-primary trading-redcolor',
        arrowClass : 'icon-arrowup',
        entrustRecord : [],
        entrustTab : [
            ['doing' ,"进行中的委托"],
            ['history' ,"历史委托"]
        ],
        currentEntrustTab : 'doing',
        showModal: false,
        billParams: {},
        userParams: {},
        entrustParams: {},
        refundParams: {},
        currentTradeMode : 0,
        //输入价格模式：0输入原始价格，1输入转换价格
        inputPriceMode : Methods.getCookie(ENV + 'inputPriceMode') || 0,
        //开盘时间处理
        marketOpenTime : ['-','-','-','-'],
        marketOpenStatus : false,
        marketStartTime : '--',
        entrustScroll : '',
        feedss:true,
        myTradeType:"1",
        entrustType:"all",
        entrustArr:{},
        entrustArrLength:true,
        historyArr:{},
        historyArrLength:true,
        historyType:false,
        historyTypes:'0',
        historyTypeName:'全部',
        historyStatus:false,
        historyStatuss:'0',
        historyStatusName:'全部',
        historyTime:false,
        historyTimes:'All',
        historyTimeName:'全部',
        DishDatasA:[],
        DishDatasB:[],
      }
    },
    computed:{
     currentMarketConfig : function () {
        if(this.marketConfig){
            var config = this.marketConfig[this.currentMarket];
            //处理模拟盘的币种名称
            if(config.demoMode) {
                config.coinName = config.coinName.substring(1);
                config.moneyName = config.moneyName.substring(1);
                this.coinName = config.coinName;
                this.moneyName = config.moneyName;
            }
            return config;
        }else{
            return {}
        }
      },
      currentMarketLever : function () {
          // console.log(this.currentUserAsset)
          if(!this.currentUserAsset.marketLevers){
              this.currentUserAsset.marketLevers = {}
          }
          return this.currentUserAsset.marketLevers[this.currentMarket];
      },
      currentAccountId: function () {
          if (this.isLogin) {
              return Methods.getCookie(ENV + 'currentAccountId') || Methods.getCookie(ENV + 'uid');
          }
      },
      canUseCoinReal: function () {
          if(this.isLogin){
              return this.showCoin(this.getUseable(this.coin));
          }else{
              return "--";
          }
      },
      canUseMoneyReal: function () {
          if(this.isLogin){
              return this.showMoney(this.getUseable(this.money));
          }else{
              return "--"; 
          }
      },
      canUseCoin: function () {
          // 应该是显示币种的地方
          if(this.isLogin){
              return this.showCoin(this.getAllUseable(this.coin));
          }else{
              return "--";
          }
      },
      canUseCoins: function () {
          // 应该是显示币种的地方
          if(this.isLogin){
              return isNaN(Methods.fixNumber(this.canUseCoin*this.currentPrice, 4))?"--":Methods.fixNumber(this.canUseCoin*this.currentPrice, 4)
          }else{
              return "--";
          }
      },
      canUseMoney: function () {
          if(this.isLogin){
              return this.showMoney(this.getAllUseable(this.money));
          }else{
              return "--";
          }
      },
      canUseMoneys: function () {
          if(this.isLogin){
              return isNaN(Methods.fixNumber(this.canUseMoney/this.currentPrice, 4))?"--":Methods.fixNumber(this.canUseMoney/this.currentPrice, 4)
          }else{
              return "--";
          }
      },

      canBuyCoinReal: function () {
          if (!this.isLogin || !this.sellOne) {
              return '--';
          } else {
              var canbuy = Methods.numDivide(this.getUseable(this.money), this.sellOne);
              return this.showCoin(canbuy);
          }
      },
      canSellMoneyReal: function () {
          if (!this.isLogin || !this.buyOne) {
              return '--';
          } else {
              var cansell = Methods.numMultiply(this.getUseable(this.coin), this.buyOne);
              return this.showMoney(cansell);
          }
      },
      canBuyCoin: function () {
          if (!this.isLogin || !this.sellOne) {
              return '--';
          } else {
              var canbuy = Methods.numDivide(this.getAllUseable(this.money), this.sellOne);
              return this.showCoin(canbuy);
          }
      },
      canSellMoney: function () {
          if (!this.isLogin || !this.buyOne) {
              return '--';
          } else {
              var cansell = Methods.numMultiply(this.getAllUseable(this.coin), this.buyOne);
              return this.showMoney(cansell);
          }
      },
      canLoanCoin : function () {
          if (!this.isLogin || !this.currentUserAsset.coinFundMap || !this.currentUserAsset.coinFundMap[this.coin]) {
              return '--';
          } else {
              return this.showCoin(this.currentUserAsset.coinFundMap[this.coin].canLoan);
          }
      },
      canLoanMoney : function () {
          if (!this.isLogin || !this.currentUserAsset.coinFundMap || !this.currentUserAsset.coinFundMap[this.money]) {
              return '--';
          } else {
              return this.showMoney(this.currentUserAsset.coinFundMap[this.money].canLoan);
          }
      },
      hasLoanCoin : function () {
          if (!this.isLogin || !this.currentUserAsset.coinFundMap || !this.currentUserAsset.coinFundMap[this.coin]) {
              return '--';
          } else {
              return this.showCoin(this.currentUserAsset.coinFundMap[this.coin].loanIn);
          }
      },
      hasLoanMoney : function () {
          if (!this.isLogin || !this.currentUserAsset.coinFundMap || !this.currentUserAsset.coinFundMap[this.money]) {
              return '--';
          } else {
              return this.showMoney(this.currentUserAsset.coinFundMap[this.money].loanIn);
          }
      },

    },
    watch:{
      entrustArr : function (newVal, oldVal) {
          if(newVal.length>0){
            this.entrustArrLength = false;
          }else{
            this.entrustArrLength = true;
          }
      },
      historyArr : function(newVal,oldVal){
        if(newVal.length>0){
            this.historyArrLength = false;
          }else{
            this.historyArrLength = true;
          }
      }
    },
    methods: {
      formatDateTime:function(inputTime,type){
        var date = new Date(inputTime);  
        var y = date.getFullYear();    
        var m = date.getMonth() + 1;    
        m = m < 10 ? ('0' + m) : m;    
        var d = date.getDate();    
        d = d < 10 ? ('0' + d) : d;    
        var h = date.getHours();  
        h = h < 10 ? ('0' + h) : h;  
        var minute = date.getMinutes();  
        var second = date.getSeconds();  
        minute = minute < 10 ? ('0' + minute) : minute;    
        second = second < 10 ? ('0' + second) : second;
        if(type==1){
          return  m + '-' + d
        }else if(type==2){
          return h+':'+minute+':'+second;   
        }else{
          return  m + '-' + d+' '+h+':'+minute+':'+second;   
        }
      },
      myTradeTypes:function(type){
        this.myTradeType = type;
        if(type==2){
          this.entrustAjax();
        }else if(type==3){
          this.historyAjax();
        }
        // else if(type==1 || type ==0){
        //   this.getAssistPrice();
        // }
      },
      entrustAjax:function(){
        var _this = this
               
        if(_this.isLogin){
          $.ajax({
            url:httpUrl+"app/Trade/entrust",
            type:"post",
            data:{"user":user,"market":this.currentMarket,status:"1",typepay:"0",timerweituo:"All"},
            dataType:"jsonp",
            jsonpCallback: "showData",
            success:function(res){
              _this.entrustArr = res.data;
            }
          })
        }
      },
      historyAjax:function(){
        var _this = this
        if(_this.isLogin){
          $.ajax({
            url:httpUrl+"app/Trade/entrust",
            type:"post",
            data:{user:user,market:this.currentMarket,status:_this.historyStatuss,typepay:_this.historyTypes,timerweituo:_this.historyTimes},
            dataType:"jsonp",
            success:function(res){
              console.log(res)
              _this.historyArr = res.data;
            }
          })
        }
      },
      setShowType:function(type){
        this.showType = type;
      },
      transactionTypes:function(type,name){
        this.transactionType = type;
        this.transactionName = name;
        this.transactionTypesShow = false;
      },
      transactionTypesShows:function(type,name){
        this.transactionTypesShow = !this.transactionTypesShow;
         this.showPriceType = false;
      },
      PriceShows:function(){
        this.showPriceType = !this.showPriceType;
        this.transactionTypesShow = false;
      },

      // 历史委托下拉
      historyTypeShow:function(){
        this.historyType = !this.historyType;
        this.historyStatus = false;
        this.historyTime = false;
      },
      historyTypeShows:function(type,name){
        this.historyTypes = type;
        this.historyTypeName = name;
        this.historyType = false;
        this.historyAjax()
      },
      historyStatusShow:function(){
        this.historyStatus = !this.historyStatus;
        this.historyType = false;
        this.historyTime = false;
      },
      historyStatusShows:function(type,name){
        this.historyStatuss = type;
        this.historyStatusName = name;
        this.historyStatus = false;
        this.historyAjax()
      },
      historyTimeShow:function(){
        this.historyTime = !this.historyTime;
        this.historyType = false;
        this.historyStatus = false;
      },
      historyTimeShows:function(type,name){
        this.historyTimes = type;
        this.historyTimeName = name;
        this.historyTime = false;
        this.historyAjax()
      },


      showMoney : function (val) {
          if(isNaN(val)){
              return '--'
          }else{
              return Methods.fixNumber(val, this.currentMarketConfig.moneyDecimal)
          }
      },
      showCoin : function (val) {
          if(isNaN(val)){
              return '--'
          }else{
              return Methods.fixNumber(val, this.currentMarketConfig.coinDecimal)
          }
      },
      showAssistCoin : function () {
          //显示辅助货币名字，不显示默认
          if(this.assistCoin == 'none'){
              return this.moneyName;
          }else{
              return this.assistList[this.assistCoin].name || this.moneyName;
          }
      },
      showAssistName : function () {
          //显示辅助货币名字，有默认显示
          return this.assistList[this.assistCoin].name || this.moneyName;
      },
      //价格折合的提示内容
      showAssistHint : function (price) {
          return "折合:" + this.getPriceByAssist(price) + " " + this.showAssistCoin();
      },
      userActionSuccess: function() {
          return function() {
              //this.getUsersInfo();
              this.showModal = false;
              this.getTargetUserAsset();
          }.bind(this)
      },
      //切换价格输入模式
      toggleInputPriceMode : function () {
         
          if(this.inputPriceMode == 0){
              Methods.setCookie(ENV + 'inputPriceMode', 1, 7);
              this.inputPriceMode = 1;
          }else{
              Methods.setCookie(ENV + 'inputPriceMode', 0, 7);
              this.inputPriceMode = 0;
          }
      },
      //检测当前价格输入模式，不合法则恢复默认
      checkInputPriceMode : function () {
          if(this.moneyName == this.showAssistCoin()){
              Methods.setCookie(ENV + 'inputPriceMode', 0, 7);
              this.inputPriceMode = 0;
          }
      },
      openBill: function() {
          this.billParams = {
              userId: this.currentAccountId,
              coin: this.coin
          };
          this.showModal = 'bill';
      },
      openEntrust: function() {
          this.entrustParams = {
              market: this.currentMarket,
              userId: this.currentAccountId
          };
          this.showModal = 'entrust';
      },
      openRefund: function(coin) {
          this.refundParams = {
              userId: this.currentAccountId,
              coin: coin
          };
          this.showModal = 'refund';
      },
      // 获取币价汇率
      getAssistPrice: function (callback) {
        var _this = this;
        if(_this.myTradeType==1 || _this.myTradeType==0){
          $.ajax({
              type:"get",
              dataType:"jsonp",
              url:httpUrl+"app/market/ratio",
              success: function (res) {
                 _this.assistPrice = res.datas;
                 // oneRatio = true;
                  try{
                      _this.$refs.dishPart.flushAssistPrice();
                      _this.$refs.dealRecord.flushAssistPrice();
                  }catch(err){
                      console.log('miss dish part component.')
                  }
                  callback && callback(res.datas); 
              }
          });
        }
      },
      // 获取盘口数据
      getDishData: function(callback) {
          var _this = this;

          var getDishDataByAjax = function(){
              var data = {
                  market: _this.currentMarket,
                  length: _this.depthShowSize,
                  casuals:_this.casuals,
                  adarr:_this.DishDatasA,
              };
              if(_this.myTradeType==1 || _this.myTradeType==0){
               $.ajax({
                url:httpUrl+"app/Trade/entrusts",
                // url:"/index/Trade/entrust",
                type:"post",
                data:data,
                dataType:"jsonp",
                success:function(res){
                  _this.casuals++;
                 
                    _this.DishDatasA = res.adarr;
                  
                  _this.mixDishArray(res);
                  callback && callback(res);
                }
              })
             }
          }

          var getDishDataByWebsocket = function () {
              var channel = {
                  // event : "addChannel",
                  event : "entrust",
                  channel : _this.coin + _this.money + "_cny_depth",
                  market:  _this.currentMarket,
              }
              //如果没有则初始化
              if(typeof AlicmsWebSocket.channelManage.dishData == 'undefined'){
                  AlicmsWebSocket.channelManage.dishData = {
                      message : channel,
                      sended :false,
                      method : function (res) {
                          _this.mixDishArray(res);
                          callback && callback(res); 
                      }
                  };
              }
          }

          //推送与ajax方式智能切换

          if(AlicmsWebSocket && AlicmsWebSocket.openWebSocket && !!_this.currentMarketConfig.isPush){
              getDishDataByWebsocket();
              //getDishDataByAjax();
          }else{
              getDishDataByAjax();
          } 
      },
      getDealRecord: function(callback) {
          var _this = this;
          var doDealRecord = function (res) {
              var datas = res.datas || res.data;
              if(datas && datas.length > 0){
                  _this.dealRecord = datas.slice(0, _this.tradesLimit);
              
                  // console.log("zou1")
                  try{
                  // console.log("zou2")

                      if(_this.last_trade_tid != 0){
                  // console.log("zou3")
                          _this.$refs.dealRecord.pushTrades(_this.dealRecord);
                      }else{
                  // console.log("zou4")

                                  _this.$refs.dealRecord.setFirstRecord(_this.dealRecord);
                      }
                  }catch (err){
                  // console.log("zouXXX")

                  }
                  _this.last_trade_tid = _this.dealRecord[_this.dealRecord.length - 1].tid;
                  _this.last_trade_time = _this.dealRecord[_this.dealRecord.length - 1].date;
              }
          };
          //ajax获取成交记录
          var getDealRecordByAjax = function () {
              var data = {
                  market: _this.currentMarket,
                  length: _this.depthShowSize,
                  addtime:_this.last_trade_time,
              };
              if(_this.last_trade_time==0){
                  $("#tradeRecord .tradeNew-table").html('')
              }
              if(_this.myTradeType==1 || _this.myTradeType==0){
              //     oneciDeal = false;
                  $.ajax({
                    url: httpUrl+"app/Trade/deal",
                    data: data,
                    type:"post",
                    dataType:"jsonp",
                    success: function (res) {
                      oneciDeal =true;
                      if(res.data.length==0){
                        return false;
                      }
                      for (var i = 0; i < res.data.length; i++) {
                        if(res.data[i]['type']==1){
                          res.data[i]['type']="buy"
                        }else{
                          res.data[i]['type']="sell"
                        }
                      }
                      
                      doDealRecord(res);
                    }
                  })
              }
          };
          // webSocket方法获取成交记录
          var getDealRecordByWebsocket = function () {
              var channel = {
                  // event : "addChannel",
                  event : "bargain",
                  market: _this.currentMarket,
                  channel : _this.coin + _this.money + "_cny_lasttrades",
                  last_trade_tid : _this.last_trade_tid
              }


              //如果没有则初始化
              if(typeof AlicmsWebSocket.channelManage.dealRecord == 'undefined'){
                  AlicmsWebSocket.channelManage.dealRecord = {
                      message : channel,
                      sended :false,
                      method : function (json) {
                          doDealRecord(json);
                      }
                  };
              }
          }
          if(AlicmsWebSocket && AlicmsWebSocket.openWebSocket && !!_this.currentMarketConfig.isPush){
              getDealRecordByWebsocket();
              //getDealRecordByAjax();
          }else{
              getDealRecordByAjax();
          }
          callback && callback();
      },
      //告诉服务器websocket 是否在线
      getWebsocketInfo:function(callback){
          var _this = this
          var channel = {
              event : "heartbeat",
              market: _this.currentMarket,
              channel : _this.coin + _this.money + "_cny_lasttrades",
              
          }
          //如果没有则初始化
          
              AlicmsWebSocket.channelManage.heartbeat = {
                  message : channel,
                  sended :false,
              };
     
          callback && callback();
      },
      // 获取用户资金
      getTargetUserAsset: function (callback) {

          var _this = this;
          var data = {
              lastTime : _this.lastAssetTime,
              market : _this.currentMarket,
              user:user
          };
          if(_this.myTradeType==1 || _this.myTradeType==0){
          $.ajax({
              url:httpUrl+"app/Trade/getTargetUserAssetNew",
              data:data,
              type:"post",
              dataType:"jsonp",
              success: function (res) {
                  //时间戳不相等才更新
                  var mydata = {
                      coinFundMap:{

                      },
                      lastTime:res.datas.lastTime,
                      marketLevers:undefined
                  }

                  if(res.datas.coinFundMap){
                      for(var key in res.datas.coinFundMap){
                          mydata.coinFundMap[key] = {
                              available:res.datas.coinFundMap[key].normal,
                              freez:res.datas.coinFundMap[key].freeze,
                              total:res.datas.coinFundMap[key].sum,
                          }
                      }
                      _this.currentUserAsset = mydata;
                      _this.lastAssetTime = mydata.lastTime;
                      callback && callback();
                  }else{
                      _this.lastAssetTime = res.datas.lastTime
                  }
              }
          })
        }
      },
      // 设置辅助币种
      setAssistCoin: function (coin) {
        this.assistCoin = coin;
        this.showPriceType = !this.showPriceType;
        if( this.myTradeType == 1){
          this.$refs.tradeFormBuy.convertPrice(this.$refs.tradeFormBuy.inputPrice,0,1)
        }else if(this.myTradeType == 0){
          this.$refs.tradeFormSell.convertPrice(this.$refs.tradeFormSell.inputPrice,0,1)

        }
        
      },
      //合并盘口数据
     mixDishArray: function (res) {
      var _this = this;
      //增量更新的合并盘口方法
      var mixArray = function (oldArray, newArray) {
          // console.log(oldArray, newArray,333)
          var m = new top.hashMap();
          var n = new top.hashMap();
          var resultArray = [];

          for (var i = 0, ilength = oldArray.length; i < ilength; i++) {
              m.put(parseFloat(oldArray[i][0]), oldArray[i][1]);
          }
          for (var i = 0, ilength = newArray.length; i < ilength; i++) {
              n.put(parseFloat(newArray[i][0]), newArray[i][1]);
          }
          m.each(function (key, value, index) {
              var na = n.get(key);
              if (na) {
                  m.put(key, na);
              }
          });
          n.each(function (key, value, index) {
              if (value == 0) {
                  m.remove(key);
              } else {
                  m.put(key, value);
              }
          });
          m.each(function (key, value, index) {
              resultArray[index] = []
              resultArray[index][0] = key;
              resultArray[index][1] = value;
          });
          return resultArray.reverse();
      }
      //封装为统一的结构
      var result = {
          datas: {}
      };
      if (res.datas) {
          _this.currentPrice = res.datas.currentPrice;
          //兼容写法
          if (res.datas.listUp) {
              result.datas.asks = res.datas.listUp;
              result.datas.bids = res.datas.listDown;
          } else {
              result.datas.asks = res.datas.asks;
              result.datas.bids = res.datas.bids;
          }
      } else {
          //推送的数据处理
          _this.currentPrice = res.currentPrice;
          result.datas.asks = res.asks;
          result.datas.bids = res.bids;
      }
      //倒序
      //合并盘口数据
      var data = result.datas;
          //处理增量推送
          var resultAsksArray, resultBidsArray;
          
              resultAsksArray = mixArray(_this.lastDepth.asks, data.asks);
              resultBidsArray = mixArray(_this.lastDepth.bids, data.bids);
          
          _this.lastDepth.asks = resultAsksArray;
          _this.lastDepth.bids = resultBidsArray;
          Vue.set(_this.lastDepth, 'asks', resultAsksArray);
          Vue.set(_this.lastDepth, 'bids', resultBidsArray);
          try{
              _this.$refs.dishPart.updateDepth(_this.lastDepth);
          }catch (err){
            // console.log("cuole?")
          }
      //计算最大深度值
      var getMaxDepth = function (depth) {
          var maxNum = 0 ;
          //求卖单最大深度值
          for(var i = 0;i < depth.length; i++){
              if(parseFloat(depth[i][1]) > maxNum){
                  maxNum = parseFloat(depth[i][1]);
              }
          }

          return maxNum;
      }
      //最大深度值
      Vue.set(_this.lastDepth, 'maxbBids', getMaxDepth(_this.lastDepth.bids));
      Vue.set(_this.lastDepth, 'maxAsks', getMaxDepth(_this.lastDepth.asks));
    // }

  },
  //获取币种的可用资金
  getAllUseable: function (coin) {
      var _this = this;
      // console.log(_this.currentUserAsset.coinFundMa,_this.currentUserAsset.coinFundMap[coin])
      if (!_this.currentUserAsset.coinFundMap || !_this.currentUserAsset.coinFundMap[coin]) {
          return '--';
      } else {

          var coinAsset = _this.currentUserAsset.coinFundMap[coin];
          var useable = coinAsset.available || 0;
          var canLoan = coinAsset.canLoan || 0;
          if (_this.currentMarketLever) {
              useable = Number(useable) + Number(canLoan);
          }

          return useable;
      }
  },
  //获取指定辅助货币的价格 列表折合价 输入货币转金额
  getPriceByAssist: function (price) {
      if(!price || price == '' || this.assistPrice == null){
          return ''
      }

      var money = this.money;
      var assistCoin = this.assistCoin;
      if (assistCoin == 'none' || assistCoin == '') {
          return Methods.fixNumber(price, this.currentMarketConfig.moneyDecimal);
      } else {
          return Methods.fixNumber(parseFloat(price) * parseFloat(this.assistPrice[assistCoin][money]), this.assistList[assistCoin].decimal) || '--';
      }
  },
  //获取辅助货币价格的下单价
  getPriceByPrice: function (price) {
      if(!price || price == ''){
          return ''
      }
      var money = this.money;
      var assistCoin = this.assistCoin;
      if (assistCoin == 'none' || assistCoin == '') {
          return Methods.fixNumber(price, this.currentMarketConfig.moneyDecimal);
      } else {
          return Methods.fixNumber(parseFloat(price) / parseFloat(this.assistPrice[assistCoin][money]), this.currentMarketConfig.moneyDecimal) || '--';
      }
  },
  //过滤指定的委托
  getGroupEntrust: function (group) {
      var result = [];
      this.entrustRecord.forEach(function (item) {
          if(group == 'doing' && (item[7] == 3 || item[7] == 0)){
              result.push(item);
          }
          if(group == 'history' && (item[7] == 1 || item[7] == 2)){
              result.push(item);
          }
      })
      return result;
  },
  getMarketConfig: function (callback) {
     // alert(mystr)        
      var _this = this;
      $.ajax({
          url:httpUrl+"app/Market/marketList",
          type:"post",
          dataType:"jsonp",
          success: function (res) {
            var m = res.data;
              var myself={
              datas:{}
          };
          for(var val of m){
                  myself.datas[val['market']]={
                  amountDecimal:8,
                  coin:val["coin_pre"],
                  coinDecimal:val["coin_decimal"],
                  moneyDecimal:val["money_decimal"],
                  coinName:val["coin_pre"].toUpperCase(),
                  demoMode:false,
                  id:val["id"],
                  key:val["market"],
                  money:val["coin_suf"],
                  moneyName:val["coin_suf"].toUpperCase(),
                  name:val["market"].toUpperCase(),
                  openMode:val["status"],
                  leverType:0,
                  isShow:true,
                  isPush:true
              }
          }
            _this.marketConfig = myself.datas;

              callback && callback(myself.datas); 
          }
      })
      }, 
      showAssistCoin : function () {
          //显示辅助货币名字，不显示默认
          if(this.assistCoin == 'none'){
              return this.moneyName;
          }else{
              return this.assistList[this.assistCoin].name || this.moneyName;
          }
      },
      //获取指定辅助货币的价格 列表折合价 输入货币转金额
      //      console.log('控制显示位数的地方')
      getPriceByAssist: function (price) {
          if(!price || price == '' || this.assistPrice == null){
              return ''
          }
          var money = this.money;
          var assistCoin = this.assistCoin;
          // console.log(price,money,assistCoin,this.assistPrice)
          // console.log(this.assistList,this.assistList[assistCoin].decimal)
          if (assistCoin == 'none' || assistCoin == '') {
              return Methods.fixNumber(price, this.currentMarketConfig.moneyDecimal);
          } else {
              return Methods.fixNumber(parseFloat(price) * parseFloat(this.assistPrice[assistCoin][money]), this.assistList[assistCoin].decimal) || '--';
          }
      },
      // 撤销委托
      doCancelEntrust:function(id){
        var _this = this;
        var data = {
            id:id,
            market: _this.currentMarket,
            user:user
        };
        $.ajax({
          url:httpUrl+"app/trade/cancellation",
          type:"post",
          data:data,
          dataType:"jsonp",
          success:function(res){
            if(res.code==1){
              $.toast({
                  text: res.msg,
                  icon: 'success',
                  loader: true,
                  loaderBg: '#9EC600'
              });
              _this.entrustAjax();
            }else{
              $.toast({
                  text: res.msg,
                  icon: 'error',
                  loader: true,
                  loaderBg: '#9EC600'
              });
            }
          }
        })
      }

    },
    
    created: function () {
        var _this = this;
        //先获取配置和价格表
        _this.getMarketConfig(function () {
            //排查错误市场
            if(!_this.marketConfig[_this.currentMarket]){ 
                JuaBox.info('Error Market !', function () {
                    top.location.href = '/';
                })
                return false;
            }
            

            _this.getAssistPrice(function () {
                //获取盘口定时器
                _this.getDishData(function () {
                    setInterval(_this.getDishData, 3000);
                });
                _this.getWebsocketInfo(function () {
                    setInterval(_this.getWebsocketInfo, 30000);
                });
                //获取成交记录定时器
                _this.getDealRecord(function () {
                    setInterval(_this.getDealRecord, 3000);
                });
                //获取市场行情数据
                // _this.getAllMarket(function () {
                //     setInterval(_this.getAllMarket, 10000);
                // });
                //获取价格表定时器
                _this.getAssistPrice(function () {
                    setInterval(_this.getAssistPrice, 3000);
                });
                //登录后的数据获取
                if (_this.isLogin) {
                    //获取资金定时器
                    _this.getTargetUserAsset(function () {
                        setInterval(_this.getTargetUserAsset, 5000);
                        //_this.checkMarketCoin();
                    });
                    //获取委托记录定时器
                    // _this.getEntrustRecord(function () {
                    //     // _this.initEntrustScroll();
                    //     setInterval(_this.getEntrustRecord, 3000);
                    // });
                }
            })
        })
    },
  })
})
</script>
</body>
</html>







